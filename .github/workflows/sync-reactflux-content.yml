name: Sync ReactFlux gh-pages content
on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  sync-content:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download and sync gh-pages content
        run: |
          # Download the gh-pages branch as zip
          wget -q https://github.com/electh/ReactFlux/archive/refs/heads/gh-pages.zip -O gh-pages.zip
          unzip -q gh-pages.zip
          rm gh-pages.zip

          # Backup files to preserve
          mkdir -p preserve-temp
          [ -f "CNAME" ] && cp CNAME preserve-temp/
          [ -f "README.md" ] && cp README.md preserve-temp/
          [ -f "LICENSE" ] && cp LICENSE preserve-temp/

          # Clear existing content except protected files/folders
          find . -mindepth 1 \
            ! -name '.git' \
            ! -name '.github' \
            ! -name 'CNAME' \
            ! -name 'README.md' \
            ! -name 'LICENSE' \
            -exec rm -rf {} +

          # Move content from the unzipped folder (handle both possible folder structures)
          if [ -d "ReactFlux-gh-pages" ]; then
            mv ReactFlux-gh-pages/* ./
            rm -rf ReactFlux-gh-pages
          elif [ -d "ReactFlux-gh-pages/" ]; then
            mv ReactFlux-gh-pages/* ./
            rm -rf ReactFlux-gh-pages/
          else
            echo "Warning: Unexpected directory structure in downloaded zip"
            # Try to find the content directory
            content_dir=$(find . -maxdepth 1 -type d -name "ReactFlux*" | head -n 1)
            if [ -n "$content_dir" ]; then
              mv "$content_dir"/* ./
              rm -rf "$content_dir"
            fi
          fi

          # Restore preserved files
          [ -f "preserve-temp/CNAME" ] && mv preserve-temp/CNAME ./
          [ -f "preserve-temp/README.md" ] && mv preserve-temp/README.md ./
          [ -f "preserve-temp/LICENSE" ] && mv preserve-temp/LICENSE ./
          rm -rf preserve-temp

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global --add safe.directory /github/workspace
          git add -A
          git diff-index --quiet HEAD || git commit -m "Auto-sync with ReactFlux gh-pages content"
          git push
